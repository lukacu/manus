glMatrix.setMatrixArrayType(Array);vec3.fromXYZ=function(a){var b=new Array(3);b[0]=a.x;b[1]=a.y;b[2]=a.z;return b};vec3.toXYZ=function(a){return{x:a[0],y:a[1],z:a[2]}};vec4.fromXYZ=function(b,a){var c=new Array(4);c[0]=b.x;c[1]=b.y;c[2]=b.z;c[3]=a;return c};mat4.fromYPR=function(e,c,d){var f=new Array(16);var b=Math.sin(d),a=Math.cos(d),j=Math.sin(c),i=Math.cos(c),h=Math.sin(e),g=Math.cos(e);f[0]=g*a;f[4]=-(g*b);f[8]=h;f[1]=(j*h*a)+(i*b);f[5]=(i*a)-(j*h*b);f[9]=-(j*g);f[2]=(j*b)-(i*h*a);f[6]=(j*a)+(i*h*b);f[10]=i*g;f[3]=0;f[7]=0;f[11]=0;f[12]=0;f[13]=0;f[14]=0;f[15]=1;return f};quat.fromYPR=function(e,a,b){var c=b*0.5;var i=Math.sin(c);var j=Math.cos(c);var f=a*0.5;var k=Math.sin(f);var l=Math.cos(f);var g=e*0.5;var m=Math.sin(g);var h=Math.cos(g);var d=new Array(4);d[0]=((h*k)*j)+((m*l)*i);d[1]=((m*l)*j)-((h*k)*i);d[2]=((h*l)*i)-((m*k)*j);d[3]=((h*l)*j)+((m*k)*i);return d};if(typeof Phoria==="undefined"||!Phoria){var Phoria={};Phoria.RADIANS=Math.PI/180;Phoria.TWOPI=Math.PI*2;Phoria.ONEOPI=1/Math.PI;Phoria.PIO2=Math.PI/2;Phoria.PIO4=Math.PI/4;Phoria.EPSILON=0.000001}(function(){Phoria.Util={};Phoria.Util.extend=function A(I,J,H){var G=function(){},E;G.prototype=J.prototype;I.prototype=new G();I.prototype.constructor=I;I.superclass=J.prototype;if(J.prototype.constructor==Object.prototype.constructor){J.prototype.constructor=J}if(H){for(E in H){if(H.hasOwnProperty(E)){I.prototype[E]=H[E]}}}};Phoria.Util.augment=function x(F,E){for(var G in E.prototype){if(typeof F.prototype[G]==="undefined"){F.prototype[G]=E.prototype[G]}}};Phoria.Util.merge=function h(E,F){var H=Array.isArray(F),G=H&&[]||{};if(H){E=E||[];G=G.concat(E);F.forEach(function(J,I){if(typeof J==="object"){G[I]=Phoria.Util.merge(E[I],J)}else{G[I]=J}})}else{if(E&&typeof E==="object"){Object.keys(E).forEach(function(I){G[I]=E[I]})}Object.keys(F).forEach(function(I){if(typeof F[I]!=="object"||!F[I]){G[I]=F[I]}else{if(!E||!E[I]){G[I]=F[I]}else{G[I]=Phoria.Util.merge(E[I],F[I])}}})}return G};Phoria.Util.combine=function D(E,F){var G=Array.isArray(F)&&Array.isArray(E);if(G){if(E.length<F.length){E.length=F.length}F.forEach(function(I,H){if(typeof I==="object"){E[H]=E[H]||{};Phoria.Util.combine(E[H],I)}else{E[H]=I}})}else{Object.keys(F).forEach(function(H){if(typeof F[H]!=="object"||!F[H]){E[H]=F[H]}else{E[H]=E[H]||(Array.isArray(F[H])?[]:{});Phoria.Util.combine(E[H],F[H])}})}};Phoria.Util.clone=function C(F){var H=null,G={};for(var E in F){H=F[E];if(Array.isArray(H)){G[E]=[].concat(H)}else{G[E]=H}}return G};Phoria.Util.isIdentity=function y(E){return(E[0]===1&&E[1]===0&&E[2]===0&&E[3]===0&&E[4]===0&&E[5]===1&&E[6]===0&&E[7]===0&&E[8]===0&&E[9]===0&&E[10]===1&&E[11]===0&&E[12]===0&&E[13]===0&&E[14]===0&&E[15]===1)};Phoria.Util.calcNormalVector=function d(G,I,K,F,H,J){var E=vec4.fromValues((I*J)-(K*H),-((J*G)-(F*K)),(G*H)-(I*F),0);return vec3.normalize(E,E)};Phoria.Util.thetaTo=function t(F,E){return Math.acos(vec3.dot(F,E)/(Math.sqrt(F[0]*F[0]+F[1]*F[1]+F[2]*F[2])*Math.sqrt(E[0]*E[0]+E[1]*E[1]+E[2]*E[2])))};Phoria.Util.averagePolyVertex=function B(H,J){for(var I=0,G=0,F=0,E=0;I<H.length;I++){G+=J[H[I]][0];F+=J[H[I]][1];E+=J[H[I]][2]}return vec3.fromValues(G/H.length,F/H.length,E/H.length)};Phoria.Util.averageObjectZ=function e(F){var G=0;for(var E=0;E<F.length;E++){G+=F[E][3]}return G/F.length};Phoria.Util.populateBuffer=function l(E,G){var H=new Array(E);for(var F=0;F<E;F++){H[F]=G(F)}return H};Phoria.Util.sortPolygons=function k(E,H){for(var F=0,I;F<E.length;F++){I=E[F].vertices;if(I.length===3){E[F]._avz=(H[I[0]][2]+H[I[1]][2]+H[I[2]][2])*0.333333}else{E[F]._avz=(H[I[0]][2]+H[I[1]][2]+H[I[2]][2]+H[I[3]][2])*0.25}}E.sort(function G(J,K){return(J._avz<K._avz?-1:1)})};Phoria.Util.sortEdges=function b(E,G){for(var F=0;F<E.length;F++){E[F]._avz=(G[E[F].a][2]+G[E[F].b][2])*0.5}E.sort(function H(I,J){return(I._avz<J._avz?-1:1)})};Phoria.Util.sortPoints=function c(F,H){var E=function G(P,Q,I,K){if(I<K){var L=(I+K)>>1,O=Q[L][2],J=I;var N=Q[L];Q[L]=Q[K];Q[K]=N;N=P[L];P[L]=P[K];P[K]=N;for(var M=I;M<K;M++){if(Q[M][2]>O){N=P[M];P[M]=P[J];P[J]=N;N=Q[M];Q[M]=Q[J];Q[J]=N;J++}}N=P[J];P[J]=P[K];P[K]=N;N=Q[J];Q[J]=Q[K];Q[K]=N;G(P,Q,I,J-1);G(P,Q,J+1,K)}};E(H,F,0,F.length-1)};Phoria.Util.generateTesselatedPlane=function n(T,F,E,I,R){var U=[],L=[],P=[],H=I/F,N=I/T,O=0;for(var M=0,S,Q=I/2;M<=T;M++){S=-I/2;for(var K=0;K<=F;K++){U.push({x:S,y:0,z:Q});if(K!==0){L.push({a:O,b:O-1})}if(M!==0){L.push({a:O,b:O-F-1})}if(M!==0&&K!==0){var G={vertices:[O-F-1,O,O-1,O-F-2]};if(R){var J=[(1/F)*K,(1/T)*(M-1),(1/F)*K,(1/T)*M,(1/F)*(K-1),(1/T)*M,(1/F)*(K-1),(1/T)*(M-1)];G.uvs=J}P.push(G)}S+=H;O++}Q-=N}return{points:U,edges:L,polygons:P}};Phoria.Util.generateUnitCube=function a(F){var E=F||1;return{points:[{x:-1*E,y:1*E,z:-1*E},{x:1*E,y:1*E,z:-1*E},{x:1*E,y:-1*E,z:-1*E},{x:-1*E,y:-1*E,z:-1*E},{x:-1*E,y:1*E,z:1*E},{x:1*E,y:1*E,z:1*E},{x:1*E,y:-1*E,z:1*E},{x:-1*E,y:-1*E,z:1*E}],edges:[{a:0,b:1},{a:1,b:2},{a:2,b:3},{a:3,b:0},{a:4,b:5},{a:5,b:6},{a:6,b:7},{a:7,b:4},{a:0,b:4},{a:1,b:5},{a:2,b:6},{a:3,b:7}],polygons:[{vertices:[0,1,2,3]},{vertices:[1,5,6,2]},{vertices:[5,4,7,6]},{vertices:[4,0,3,7]},{vertices:[4,5,1,0]},{vertices:[3,2,6,7]}]}};Phoria.Util.generatePyramid=function w(F){var E=F||1;return{points:[{x:-1*E,y:0,z:-1*E},{x:-1*E,y:0,z:1*E},{x:1*E,y:0,z:1*E},{x:1*E,y:0*E,z:-1*E},{x:0,y:1.5*E,z:0}],edges:[{a:0,b:1},{a:1,b:2},{a:2,b:3},{a:3,b:0},{a:0,b:4},{a:1,b:4},{a:2,b:4},{a:3,b:4}],polygons:[{vertices:[0,1,4]},{vertices:[1,2,4]},{vertices:[2,3,4]},{vertices:[3,0,4]},{vertices:[3,2,1,0]}]}};Phoria.Util.generateIcosahedron=function v(I){var G=I||1;var F=(1+Math.sqrt(5))/2,H=(F/Math.sqrt(1+F*F))*G,E=(1/Math.sqrt(1+F*F))*G;return{points:[{x:H,y:E,z:0},{x:-H,y:E,z:0},{x:-H,y:-E,z:0},{x:H,y:-E,z:0},{x:E,y:0,z:H},{x:E,y:0,z:-H},{x:-E,y:0,z:-H},{x:-E,y:0,z:H},{x:0,y:H,z:E},{x:0,y:-H,z:E},{x:0,y:-H,z:-E},{x:0,y:H,z:-E}],edges:[{a:4,b:8},{a:8,b:7},{a:7,b:4},{a:7,b:9},{a:9,b:4},{a:5,b:6},{a:6,b:11},{a:11,b:5},{a:5,b:10},{a:10,b:6},{a:0,b:4},{a:4,b:3},{a:3,b:0},{a:3,b:5},{a:5,b:0},{a:2,b:7},{a:7,b:1},{a:1,b:2},{a:1,b:6},{a:6,b:2},{a:8,b:0},{a:0,b:11},{a:11,b:8},{a:11,b:1},{a:1,b:8},{a:9,b:10},{a:10,b:3},{a:3,b:9},{a:9,b:2},{a:2,b:10}],polygons:[{vertices:[4,8,7]},{vertices:[4,7,9]},{vertices:[5,6,11]},{vertices:[5,10,6]},{vertices:[0,4,3]},{vertices:[0,3,5]},{vertices:[2,7,1]},{vertices:[2,1,6]},{vertices:[8,0,11]},{vertices:[8,11,1]},{vertices:[9,10,3]},{vertices:[9,2,10]},{vertices:[8,4,0]},{vertices:[11,0,5]},{vertices:[4,9,3]},{vertices:[5,3,10]},{vertices:[7,8,1]},{vertices:[6,1,11]},{vertices:[7,2,9]},{vertices:[6,10,2]}]}};Phoria.Util.subdivide=function m(G,J){var H=[],E=[];var F=function(N){var M=N.x*N.x+N.y*N.y+N.z*N.z;M=1/Math.sqrt(M);N.x*=M;N.y*=M;N.z*=M};var K=function(S,R,P){var N={x:0,y:0,z:0},O={x:0,y:0,z:0},Q={x:0,y:0,z:0};N.x=S.x+R.x;N.y=S.y+R.y;N.z=S.z+R.z;O.x=R.x+P.x;O.y=R.y+P.y;O.z=R.z+P.z;Q.x=P.x+S.x;Q.y=P.y+S.y;Q.z=P.z+S.z;F(N);F(O);F(Q);var M=H.length;H.push(S,R,P,N,O,Q);E.push({vertices:[M+0,M+3,M+5]});E.push({vertices:[M+1,M+4,M+3]});E.push({vertices:[M+2,M+5,M+4]});E.push({vertices:[M+3,M+4,M+5]})};for(var I=0,L;I<J.length;I++){L=J[I].vertices;if(L.length===3){K.call(this,G[L[0]],G[L[1]],G[L[2]])}else{if(L.length===4){K.call(this,G[L[0]],G[L[1]],G[L[2]]);K.call(this,G[L[2]],G[L[3]],G[L[0]])}}}return{points:H,polygons:E}};Phoria.Util.generateCylinder=function q(K,E,G){var M=[],L=[],I=[];var F=2*Math.PI/G;for(var O=0,H=0;O<=G;O++){M.push({x:Math.cos(H)*K,z:Math.sin(H)*K,y:E/2});M.push({x:Math.cos(H)*K,z:Math.sin(H)*K,y:-E/2});H+=F;if(O!==0){L.push({vertices:[O*2-2,O*2,O*2+1,O*2-1]});I.push({a:O*2,b:O*2-2},{a:O*2-2,b:O*2-1},{a:O*2+1,b:O*2-1});if(O===G-1){var N=[];for(var J=G;J>=0;J--){N.push(J*2)}L.push({vertices:N});N=[];for(var J=0;J<G;J++){N.push(J*2+1)}L.push({vertices:N})}}}return{points:M,edges:I,polygons:L}};Phoria.Util.generateCuboid=function o(J){var I=J.scalex||1,H=J.scaley||1,G=J.scalez||1,F=J.offsetx||0,E=J.offsety||0,K=J.offsetz||0;return{points:[{x:-1*I+F,y:1*H+E,z:-1*G+K},{x:1*I+F,y:1*H+E,z:-1*G+K},{x:1*I+F,y:-1*H+E,z:-1*G+K},{x:-1*I+F,y:-1*H+E,z:-1*G+K},{x:-1*I+F,y:1*H+E,z:1*G+K},{x:1*I+F,y:1*H+E,z:1*G+K},{x:1*I+F,y:-1*H+E,z:1*G+K},{x:-1*I+F,y:-1*H+E,z:1*G+K}],edges:[{a:0,b:1},{a:1,b:2},{a:2,b:3},{a:3,b:0},{a:4,b:5},{a:5,b:6},{a:6,b:7},{a:7,b:4},{a:0,b:4},{a:1,b:5},{a:2,b:6},{a:3,b:7}],polygons:[{vertices:[0,1,2,3]},{vertices:[0,4,5,1]},{vertices:[1,5,6,2]},{vertices:[2,6,7,3]},{vertices:[4,0,3,7]},{vertices:[5,4,7,6]}]}};Phoria.Util.generateSphere=function j(ab,X,T,Z){var W=[],G=[],E=[],O=[];for(var aa=0;aa<=X;++aa){for(var K=0;K<=T;++K){var J=aa*Math.PI/X;var F=K*2*Math.PI/T;var V=Math.sin(J);var U=Math.sin(F);var R=Math.cos(J);var H=Math.cos(F);var N=H*V;var M=R;var L=U*V;if(Z){var Q=K/T;var P=aa/X;O.push({u:Q,v:P})}W.push({x:ab*N,y:ab*M,z:ab*L})}}for(var aa=0;aa<X;++aa){for(var K=0;K<T;++K){var I=(aa*(T+1))+K;var Y=I+T+1;if(aa===0){var S={vertices:[I+1,Y+1,Y]};if(Z){S.uvs=[O[I+1].u,O[I+1].v,O[Y+1].u,O[Y+1].v,O[Y].u,O[Y].v]}E.push(S);G.push({a:I,b:Y})}else{if(aa===X-1){var S={vertices:[I+1,Y,I]};if(Z){S.uvs=[O[I+1].u,O[I+1].v,O[Y].u,O[Y].v,O[I].u,O[I].v]}E.push(S);G.push({a:I,b:Y})}else{var S={vertices:[I+1,Y+1,Y,I]};if(Z){S.uvs=[O[I+1].u,O[I+1].v,O[Y+1].u,O[Y+1].v,O[Y].u,O[Y].v,O[I].u,O[I].v]}E.push(S);G.push({a:I,b:Y});G.push({a:Y,b:Y+1})}}}}return{points:W,edges:G,polygons:E}};Phoria.Util.generateRadialGradientBitmap=function u(J,L,I){var G=document.createElement("canvas"),K=J<<1;G.width=G.height=K;var F=G.getContext("2d"),E=F.createRadialGradient(J,J,J>>1,J,J,J);E.addColorStop(0,L);E.addColorStop(1,I);F.fillStyle=E;F.fillRect(0,0,K,K);var H=new Image();H.src=G.toDataURL("image/png");return H};Phoria.Util.request=function g(E){var F=new XMLHttpRequest();var G=E.data||"";if(E.responseContentType&&F.overrideMimeType){F.overrideMimeType(E.responseContentType)}F.open(E.method?E.method:"GET",E.url);if(E.requestContentType){F.setRequestHeader("Accept",E.requestContentType)}F.onreadystatechange=function(){if(F.readyState===4){if(F.status===200){if(E.fnSuccess){E.fnSuccess.call(this,F.responseText,F.status)}}else{if(E.fnFailure){E.fnFailure.call(this,F.responseText,F.status)}else{alert(F.status+"\n\n"+F.responseText)}}}};try{if(E.method==="POST"||E.method==="PUT"){F.send(G)}else{F.send(null)}}catch(H){alert(H.message)}};Phoria.Util.importGeometryWavefront=function r(E){var I=[],F=[],H=[];var P=/\s+/;var G=E.scale||1;var O,N,M,L,K,J;O=N=M=L=K=J=0;Phoria.Util.request({url:E.url,fnSuccess:function(am){var Q=am.split("\n");for(var ag=0;ag<Q.length;ag++){var Z=Q[ag].split(P);switch(Z[0]){case"v":var Y=parseFloat(Z[1])*G,X=parseFloat(Z[2])*G,W=parseFloat(Z[3])*G;I.push({x:Y,y:X,z:W});if(Y<O){O=Y}else{if(Y>L){L=Y}}if(X<N){N=X}else{if(X>K){K=X}}if(W<M){M=W}else{if(W>J){J=W}}break;case"vt":var ab=parseFloat(Z[1]),aa=parseFloat(Z[2]);H.push([ab,aa]);break;case"f":Z.splice(0,1);var U=[],R=[];for(var af=0,ah,al;af<Z.length;af++){ah=Z[E.reorder?Z.length-af-1:af];if(ah.length!==0){al=ah.split("/");U.push(parseInt(al[0])-1);if(al.length>1&&ah.indexOf("//")===-1){var V=parseInt(al[1])-1;if(H.length>V){R.push(H[V][0],H[V][1])}}}}var T={vertices:U};F.push(T);if(R.length!==0){T.uvs=R}break}}if(E.center){var ae=(O+L)/2,ad=(N+K)/2,ac=(M+J)/2;for(var ag=0;ag<I.length;ag++){I[ag].x-=ae;I[ag].y-=ad;I[ag].z-=ac}}if(E.scaleTo){var ak=L-O,aj=K-N,ai=J-M;var S=0;if(aj>ak){if(ai>aj){S=1/(ai/E.scaleTo)}else{S=1/(aj/E.scaleTo)}}else{if(ai>ak){S=1/(ai/E.scaleTo)}else{S=1/(ak/E.scaleTo)}}for(var ag=0;ag<I.length;ag++){I[ag].x*=S;I[ag].y*=S;I[ag].z*=S}}if(E.fnSuccess){E.fnSuccess.call(this,{points:I,polygons:F})}},fnFailure:function(Q){if(E.fnFailure){E.fnFailure.call(this,Q)}}})};Phoria.Util.calculatePolarFromPlanar=function p(F){var E=new vec3.create();E[0]=vec3.length(F);E[1]=Math.acos(F[2]/E[0]);if(F[0]!==0){if(F[0]>0){E[2]=Math.atan(F[1]/F[0])}else{E[2]=Math.PI+Math.atan(F[1]/F[0])}}else{if(F[1]>0){E[2]=Math.PI/2}else{E[2]=Math.PI*3/2}}return E};Phoria.Util.calculatePlanarFromPolar=function s(E){return new vec3.fromValues(Math.round(E[0]*Math.sin(E[1])*Math.cos(E[2])*100)/100,Math.round(E[0]*Math.sin(E[1])*Math.sin(E[2])*100)/100,Math.round(E[0]*Math.cos(E[1])*100)/100)};Phoria.Util.planeLineIntersection=function z(I,F,H,G){var E=vec3.dot(H,I);if(E!==0){var K=new vec3.create();vec3.subtract(K,F,G);var J=vec3.dot(I,K)/E;var L=vec3.create();vec3.scaleAndAdd(L,G,H,J);return L}else{return null}};Phoria.Util.intersectionInsidePolygon=function f(K,L,E){var G=vec3.fromValues(Math.abs(K._worldnormal[0]),Math.abs(K._worldnormal[1]),Math.abs(K._worldnormal[2]));var M=0;var N=vec2.fromValues(1,1);for(var F=0;F<K.vertices.length;F++){var I,H,J;if(G[2]>=G[0]&&G[2]>=G[1]){I=vec2.fromValues(L[K.vertices[F]][0],L[K.vertices[F]][1]);H;if(F<K.vertices.length-1){H=vec2.fromValues(L[K.vertices[F+1]][0],L[K.vertices[F+1]][1])}else{H=vec2.fromValues(L[K.vertices[0]][0],L[K.vertices[0]][1])}J=vec2.fromValues(E[0],E[1])}else{if(G[1]>G[0]){I=vec2.fromValues(L[K.vertices[F]][2],L[K.vertices[F]][0]);H;if(F<K.vertices.length-1){H=vec2.fromValues(L[K.vertices[F+1]][2],L[K.vertices[F+1]][0])}else{H=vec2.fromValues(L[K.vertices[0]][2],L[K.vertices[0]][0])}J=vec2.fromValues(E[2],E[0])}else{I=vec2.fromValues(L[K.vertices[F]][1],L[K.vertices[F]][2]);H;if(F<K.vertices.length-1){H=vec2.fromValues(L[K.vertices[F+1]][1],L[K.vertices[F+1]][2])}else{H=vec2.fromValues(L[K.vertices[0]][1],L[K.vertices[0]][2])}J=vec2.fromValues(E[1],E[2])}}if(Phoria.Util.sectionLineIntersect2D(I,H,J,N)){M++}}return(M%2===1)};Phoria.Util.sectionLineIntersect2D=function i(K,I,E,J){var N=vec2.create();vec2.subtract(N,I,K);var F=vec3.create();vec2.cross(F,N,J);if(F[2]===0){return false}var M=(E[0]*J[1]-E[1]*J[0]-K[0]*J[1]+K[1]*J[0])/F[2];var L;if(J[0]!==0){L=(K[0]+M*N[0]-E[0])/J[0]}else{L=(K[1]+M*N[1]-E[1])/J[1]}var G=vec2.create();vec2.scaleAndAdd(G,K,N,M);var H={x:false,y:false};if(L>=0){if(K[0]>I[0]){if(G[0]<=K[0]&&G[0]>=I[0]){H.x=true}}else{if(G[0]>=K[0]&&G[0]<=I[0]){H.x=true}}if(K[1]>I[1]){if(G[1]<=K[1]&&G[1]>=I[1]){H.y=true}}else{if(G[1]>=K[1]&&G[1]<=I[1]){H.y=true}}}return(H.x&&H.y)}})();(function(){Phoria.Preloader=function(){this.images=[];return this};Phoria.Preloader.prototype={images:null,callback:null,counter:0,addImage:function b(c,d){var e=this;c.url=d;c.onload=function(){e.counter++;if(e.counter===e.images.length){e.callback.call(e)}};this.images.push(c)},onLoadCallback:function a(e){this.counter=0;this.callback=e;for(var d=0,c=this.images.length;d<c;d++){this.images[d].src=this.images[d].url}}}})();(function(){Phoria.BaseEntity=function(){this.matrix=mat4.create();this.children=[];return this};Phoria.BaseEntity.create=function f(t,s){if(!s){s=new Phoria.BaseEntity()}if(t.id){s.id=t.id}if(t.matrix){s.matrix=t.matrix}if(t.children){s.children=t.children}if(t.onBeforeScene){s.onBeforeScene(t.onBeforeScene)}if(t.onScene){s.onScene(t.onScene)}if(t.disabled!==undefined){s.disabled=t.disabled}return s};Phoria.BaseEntity.prototype={id:null,children:null,matrix:null,disabled:false,onBeforeSceneHandlers:null,onSceneHandlers:null,onBeforeScene:function k(s){if(this.onBeforeSceneHandlers===null){this.onBeforeSceneHandlers=[]}this.onBeforeSceneHandlers=this.onBeforeSceneHandlers.concat(s)},onScene:function d(s){if(this.onSceneHandlers===null){this.onSceneHandlers=[]}this.onSceneHandlers=this.onSceneHandlers.concat(s)},identity:function q(){mat4.identity(this.matrix);return this},invert:function j(){mat4.invert(this.matrix,this.matrix);return this},multiply:function g(s){mat4.multiply(this.matrix,this.matrix,s);return this},scale:function o(s){mat4.scale(this.matrix,this.matrix,s);return this},scaleN:function o(s){mat4.scale(this.matrix,this.matrix,vec3.fromValues(s,s,s));return this},rotate:function m(s,t){mat4.rotate(this.matrix,this.matrix,s,t);return this},rotateX:function e(s){mat4.rotateX(this.matrix,this.matrix,s);return this},rotateY:function b(s){mat4.rotateY(this.matrix,this.matrix,s);return this},rotateZ:function a(s){mat4.rotateZ(this.matrix,this.matrix,s);return this},rotateYPR:function c(v,u,t){var s=mat4.fromYPR(v,u,t);mat4.multiply(this.matrix,this.matrix,s)},translate:function i(s){mat4.translate(this.matrix,this.matrix,s);return this},translateX:function r(s){mat4.translate(this.matrix,this.matrix,vec3.fromValues(s,0,0));return this},translateY:function p(s){mat4.translate(this.matrix,this.matrix,vec3.fromValues(0,s,0));return this},translateZ:function n(s){mat4.translate(this.matrix,this.matrix,vec3.fromValues(0,0,s));return this},determinant:function l(){return mat4.determinant(this.matrix)},transpose:function h(){mat4.transpose(this.matrix,this.matrix);return this}}})();Phoria.CLIP_ARRAY_TYPE=(typeof Uint32Array!=="undefined")?Uint32Array:Array;(function(){Phoria.Entity=function(){Phoria.Entity.superclass.constructor.call(this);this.points=[];this.edges=[];this.polygons=[];this.textures=[];this.style=Phoria.Entity.createStyle();return this};Phoria.Entity.create=function d(j,i){if(!i){i=new Phoria.Entity()}Phoria.BaseEntity.create(j,i);if(j.points){i.points=j.points}if(j.polygons){i.polygons=j.polygons}if(j.edges){i.edges=j.edges}if(j.style){Phoria.Util.combine(i.style,j.style)}if(j.onRender){i.onRender(j.onRender)}i.generatePolygonNormals();return i};Phoria.Entity.createStyle=function f(j){var i={color:[128,128,128],diffuse:1,specular:0,drawmode:"solid",shademode:"lightsource",fillmode:"inflate",objectsortmode:"sorted",geometrysortmode:"automatic",linewidth:1,linescale:0,opacity:1,doublesided:false};if(j){Phoria.Util.combine(i,j)}return i};Phoria.Util.extend(Phoria.Entity,Phoria.BaseEntity,{points:null,edges:null,polygons:null,style:null,textures:null,onRenderHandlers:null,_worldcoords:null,_cameracoords:null,_coords:null,_clip:null,_averagez:0,_sorted:true,onRender:function h(i){if(this.onRenderHandlers===null){this.onRenderHandlers=[]}this.onRenderHandlers=this.onRenderHandlers.concat(i)},generatePolygonNormals:function c(){if(this.polygons){var s=this.points,r=this.polygons;for(var n=0,o,k,q,m,j,p,l;n<r.length;n++){o=r[n].vertices;k=s[o[1]].x-s[o[0]].x;q=s[o[1]].y-s[o[0]].y;m=s[o[1]].z-s[o[0]].z;j=s[o[2]].x-s[o[0]].x;p=s[o[2]].y-s[o[0]].y;l=s[o[2]].z-s[o[0]].z;r[n].normal=Phoria.Util.calcNormalVector(k,q,m,j,p,l)}}},initCoordinateBuffers:function g(){var j=this.points.length;if(this._worldcoords===null||this._worldcoords.length<j){this._worldcoords=new Array(j);for(var k=0;k<j;k++){this._worldcoords[k]=vec4.create()}}if(this._cameracoords===null||this._cameracoords.length<j){this._cameracoords=new Array(j);for(var k=0;k<j;k++){this._cameracoords[k]=vec4.create()}}if(this._coords===null||this._coords.length<j){this._coords=new Array(j);for(var k=0;k<j;k++){this._coords[k]=vec4.create()}}if(this._clip===null||this._clip.length<j){this._clip=new Phoria.CLIP_ARRAY_TYPE(j)}},getScreenBounds:function b(){var k=10000,j=10000,o=-10000,n=-10000;for(var l=0,m;l<this._coords.length;l++){m=this._coords[l];if(m[0]<k){k=m[0]}if(m[0]>o){o=m[0]}if(m[1]<j){j=m[1]}if(m[1]>n){n=m[1]}}return{minx:k,miny:j,maxx:o,maxy:n}},getWorldBounds:function e(){var k=10000,j=10000,r=10000,q=-10000,o=-10000,m=-10000;for(var l=0,n;l<this._worldcoords.length;l++){n=this._worldcoords[l];if(n[0]<k){k=n[0]}if(n[0]>q){q=n[0]}if(n[1]<j){j=n[1]}if(n[1]>o){o=n[1]}if(n[2]<r){r=n[2]}if(n[2]>m){m=n[2]}}return{minx:k,miny:j,maxx:q,maxy:o,minz:r,maxz:m}}});Phoria.Entity.debug=function a(k,l){var o="Phoria.Debug"+(k.id?(" "+k.id):"");var j=null;for(var m=0;m<k.children.length;m++){if(k.children[m].id===o){j=k.children[m];break}}if(j===null){j=new Phoria.Entity();j.id=o;j.points=[{x:0,y:0,z:0}];j.style={drawmode:"point",shademode:"callback",geometrysortmode:"none",objectsortmode:"front"};j.config={};j.onRender(function(q,i,t){q.fillStyle="#333";q.font="14pt Helvetica";var r=t;if(this.config.showId){q.fillText(k.id?k.id:"unknown - set Entity 'id' property",i,r);r+=16}if(this.config.showPosition){var s=k.worldposition?k.worldposition:j._worldcoords[0];q.fillText("{x:"+s[0].toFixed(2)+", y:"+s[1].toFixed(2)+", z:"+s[2].toFixed(2)+"}",i,r)}});k.children.push(j);var n=function(q,i,p){var r=new Phoria.Entity();r.points=[{x:0,y:0,z:0},{x:2*i[0],y:2*i[1],z:2*i[2]}];r.edges=[{a:0,b:1}];r.style={drawmode:"wireframe",shademode:"plain",geometrysortmode:"none",objectsortmode:"front",linewidth:2,color:p};r.disabled=true;return r};j.children.push(n("X",vec3.fromValues(1,0,0),[255,0,0]));j.children.push(n("Y",vec3.fromValues(0,1,0),[0,255,0]));j.children.push(n("Z",vec3.fromValues(0,0,1),[0,0,255]))}Phoria.Util.combine(j.config,l);for(var m=0;m<j.children.length;m++){j.children[m].disabled=!j.config.showAxis}}})();(function(){Phoria.PositionalAspect={};Phoria.PositionalAspect.prototype={position:null,worldposition:null,updatePosition:function a(c){var b=vec4.fromXYZ(this.position,1);vec4.transformMat4(b,b,c);this.worldposition=b}}})();(function(){Phoria.PhysicsEntity=function(){Phoria.PhysicsEntity.superclass.constructor.call(this);this.velocity={x:0,y:0,z:0};this.position={x:0,y:0,z:0};this._force={x:0,y:0,z:0};this._acceleration=null;this.gravity=true;this.onBeforeScene(this.applyPhysics);this.onScene(this.transformToScene);return this};Phoria.PhysicsEntity.create=function a(g){var f=new Phoria.PhysicsEntity();Phoria.Entity.create(g,f);if(g.velocity){f.velocity=g.velocity}if(g.position){f.position=g.position}if(g.force){f._force=g.force}if(g.gravity!==undefined){f.gravity=g.gravity}return f};Phoria.Util.extend(Phoria.PhysicsEntity,Phoria.Entity,{velocity:null,gravity:false,_force:null,_acceleration:null,impulse:function d(g){this._acceleration=g},force:function c(g){this._force=g},applyPhysics:function e(h){var g=1000/60/1000;var f=g*g;if(this._acceleration){this.velocity.x+=(this._acceleration.x*f);this.velocity.y+=(this._acceleration.y*f);this.velocity.z+=(this._acceleration.z*f);this._acceleration=null}if(this._force){this.velocity.x+=(this._force.x*f);this.velocity.y+=(this._force.y*f);this.velocity.z+=(this._force.z*f)}if(this.gravity){this.velocity.x+=(Phoria.PhysicsEntity.GRAVITY.x*f);this.velocity.y+=(Phoria.PhysicsEntity.GRAVITY.y*f);this.velocity.z+=(Phoria.PhysicsEntity.GRAVITY.z*f)}this.translate(vec3.fromXYZ(this.velocity))},transformToScene:function b(f,g){this.updatePosition(g)}});Phoria.Util.augment(Phoria.PhysicsEntity,Phoria.PositionalAspect)})();Phoria.PhysicsEntity.GRAVITY={x:0,y:-9.8,z:0};(function(){Phoria.EmitterEntity=function(){Phoria.EmitterEntity.superclass.constructor.call(this);this.position={x:0,y:0,z:0};this.positionRnd={x:0,y:0,z:0};this.velocity={x:0,y:1,z:0};this.velocityRnd={x:0,y:0,z:0};this.maximum=1000;this.gravity=true;var d=Phoria.Entity.createStyle();d.drawmode="point";d.shademode="plain";d.geometrysortmode="none";d.linewidth=5;d.linescale=2;this.style=d;this.textures=[];this._lastEmitTime=Date.now();this.onScene(this.emitParticles);return this};Phoria.EmitterEntity.create=function b(f){var d=new Phoria.EmitterEntity();Phoria.BaseEntity.create(f,d);if(f.position){d.position=f.position}if(f.positionRnd){d.positionRnd=f.positionRnd}if(f.rate){d.rate=f.rate}if(f.maximum){d.maximum=f.maximum}if(f.velocity){d.velocity=f.velocity}if(f.velocityRnd){d.velocityRnd=f.velocityRnd}if(f.lifetime){d.lifetime=f.lifetime}if(f.lifetimeRnd){d.lifetimeRnd=f.lifetimeRnd}if(f.gravity!==undefined){d.gravity=f.gravity}if(f.style){Phoria.Util.combine(d.style,f.style)}if(f.onParticle){d.onParticle(f.onParticle)}return d};Phoria.Util.extend(Phoria.EmitterEntity,Phoria.BaseEntity,{style:null,rate:0,maximum:0,velocity:null,velocityRnd:null,lifetime:0,lifetimeRnd:0,gravity:false,_lastEmitTime:0,onParticleHandlers:null,onParticle:function a(d){if(this.onParticleHandlers===null){this.onParticleHandlers=[]}this.onParticleHandlers=this.onParticleHandlers.concat(d)},emitParticles:function c(l,f,g){this.updatePosition(f);var e=Date.now();for(var j=0,d;j<this.children.length;j++){d=this.children[j];if(d._gravetime&&e>d._gravetime){this.children.splice(j,1)}}var q=e-this._lastEmitTime;var n=Math.floor((this.rate/1000)*q);if(n>0){for(var o=0;o<n&&(this.maximum===0||this.children.length<this.maximum);o++){var r={x:this.position.x,y:this.position.y,z:this.position.z};r.x+=(Math.random()*this.positionRnd.x)-(this.positionRnd.x*0.5);r.y+=(Math.random()*this.positionRnd.y)-(this.positionRnd.y*0.5);r.z+=(Math.random()*this.positionRnd.z)-(this.positionRnd.z*0.5);var s={x:this.velocity.x,y:this.velocity.y,z:this.velocity.z};s.x+=(Math.random()*this.velocityRnd.x)-(this.velocityRnd.x*0.5);s.y+=(Math.random()*this.velocityRnd.y)-(this.velocityRnd.y*0.5);s.z+=(Math.random()*this.velocityRnd.z)-(this.velocityRnd.z*0.5);var m=new Phoria.PhysicsEntity();m.position=r;m.points=[r];m.velocity=s;m.gravity=this.gravity;m.style=this.style;m.textures=this.textures;if(this.lifetime!==0){m._gravetime=Math.floor(e+this.lifetime+(this.lifetimeRnd*Math.random())-this.lifetimeRnd*0.5)}if(this.onParticleHandlers!==null){for(var k=0;k<this.onParticleHandlers.length;k++){this.onParticleHandlers[k].call(this,m)}}this.children.push(m)}this._lastEmitTime=e}}});Phoria.Util.augment(Phoria.EmitterEntity,Phoria.PositionalAspect)})();(function(){Phoria.BaseLight=function(){Phoria.BaseLight.superclass.constructor.call(this);this.color=[1,1,1];this.intensity=1;return this};Phoria.Util.extend(Phoria.BaseLight,Phoria.BaseEntity,{color:null,intensity:0})})();(function(){Phoria.DistantLight=function(){Phoria.DistantLight.superclass.constructor.call(this);this.direction={x:0,y:0,z:1};this.onScene(this.transformToScene);return this};Phoria.DistantLight.create=function a(d){var c=new Phoria.DistantLight();Phoria.BaseEntity.create(d,c);if(d.color){c.color=d.color}if(d.intensity){c.intensity=d.intensity}if(d.direction){c.direction=vec3.toXYZ(vec3.normalize(c.direction,vec3.fromXYZ(d.direction)))}return c};Phoria.Util.extend(Phoria.DistantLight,Phoria.BaseLight,{direction:null,worlddirection:null,transformToScene:function b(){this.worlddirection=vec3.fromValues(-this.direction.x,-this.direction.y,-this.direction.z)}})})();(function(){Phoria.PointLight=function(){Phoria.PointLight.superclass.constructor.call(this);this.position={x:0,y:0,z:-1};this.attenuation=0.1;this.attenuationFactor="linear";this.onScene(this.transformToScene);return this};Phoria.PointLight.create=function a(d){var c=new Phoria.PointLight();Phoria.BaseEntity.create(d,c);if(d.color){c.color=d.color}if(d.intensity){c.intensity=d.intensity}if(d.position){c.position=d.position}if(d.attenuation){c.attenuation=d.attenuation}if(d.attenuationFactor){c.attenuationFactor=d.attenuationFactor}return c};Phoria.Util.extend(Phoria.PointLight,Phoria.BaseLight,{attenuation:0,attenuationFactor:null,transformToScene:function b(d,e,c){this.updatePosition(e)}});Phoria.Util.augment(Phoria.PointLight,Phoria.PositionalAspect)})();(function(){Phoria.Scene=function(){this.camera={up:{x:0,y:1,z:0},lookat:{x:0,y:0,z:0},position:{x:0,y:0,z:-10}};this.perspective={fov:35,aspect:1,near:1,far:10000};this.viewport={x:0,y:0,width:1024,height:1024};this.graph=[];this.triggerHandlers=[];return this};Phoria.Scene.create=function(e){var d=new Phoria.Scene();if(e.camera){d.camera=Phoria.Util.merge(d.camera,e.camera)}if(e.perspective){d.perspective=Phoria.Util.merge(d.perspective,e.perspective)}if(e.viewport){d.viewport=Phoria.Util.merge(d.viewport,e.viewport)}if(e.graph){d.graph=e.graph}if(e.onCamera){d.onCamera(e.onCamera)}return d};Phoria.Scene.createFromJSON=function(e){var f=null;var d=JSON.parse(e);if(d){if(d.graph){var g=function(m){for(var j=0,l;j<m.length;j++){l=m[j];for(var k in l){if(l.hasOwnProperty(k)){if(k.indexOf("on")===0&&(l[k] instanceof string||l[k] instanceof Array)){try{}catch(h){console.log("Failed to convert expected event handler to function: "+k+"="+l[k]);throw h}}if(k==="children"&&l[k] instanceof Array){g(l[k])}}}}};g(d.graph)}}return f};Phoria.Scene.toJSON=function(e){for(var d in e){if(e.hasOwnProperty(d)&&d.indexOf("_")===0){delete e[d]}}if(e.graph){var f=function(k){for(var g=0,j;g<k.length;g++){j=k[g];for(var h in j){if(j.hasOwnProperty(h)){if(h.indexOf("on")===0&&j[h] instanceof Array){j[h]=j[h].toString()}if(h.indexOf("_")===0){delete j[h]}switch(h){case"textures":delete j[h];break;case"children":if(j[h] instanceof Array){f(j[h])}break}}}}};f(e.graph)}return JSON.stringify(e)};Phoria.Scene.prototype={camera:null,perspective:null,graph:null,viewport:null,renderlist:null,lights:null,triggerHandlers:null,onCameraHandlers:null,_entities:null,_lastTime:0,_cameraPosition:null,_perspectiveScale:0,findEntity:function c(d){return this._entities[d]},onCamera:function a(d){if(this.onCameraHandlers===null){this.onCameraHandlers=[]}this.onCameraHandlers=this.onCameraHandlers.concat(d)},modelView:function b(){var f=Date.now(),k=(f-this._lastTime)/1000;this._lastTime=f;var u=this.viewport.x,s=this.viewport.y,v=this.viewport.width*0.5,i=this.viewport.height*0.5;this._cameraPosition=vec4.fromValues(this.camera.position.x,this.camera.position.y,this.camera.position.z,0);var q=mat4.create(),e=vec4.fromValues(this.camera.lookat.x,this.camera.lookat.y,this.camera.lookat.z,0),m=vec4.fromValues(this.camera.up.x,this.camera.up.y,this.camera.up.z,0);if(this.onCameraHandlers!==null){for(var r=0;r<this.onCameraHandlers.length;r++){this.onCameraHandlers[r].call(this,this._cameraPosition,e,m)}}mat4.lookAt(q,this._cameraPosition,e,m);var n=mat4.create();mat4.perspective(n,-this.perspective.fov*Phoria.RADIANS,this.perspective.aspect,this.perspective.near,this.perspective.far);this._perspectiveScale=(256-this.perspective.fov)/16;var j=[],w=[],o={};var g=function d(t,x){for(var G=0,E,J,I;G<t.length;G++){E=t[G];if(E.disabled){continue}if(E.id){o[E.id]=E}if(E.onBeforeSceneHandlers!==null){for(var K=0;K<E.onBeforeSceneHandlers.length;K++){E.onBeforeSceneHandlers[K].call(E,this,k)}}var B=E.matrix;if(x){B=B?mat4.multiply(mat4.create(),x,B):x}if(E.onSceneHandlers!==null){for(var K=0;K<E.onSceneHandlers.length;K++){E.onSceneHandlers[K].call(E,this,B,k)}}if(E instanceof Phoria.BaseLight){w.push(E)}else{if(E instanceof Phoria.Entity){J=E.points.length;E.initCoordinateBuffers();var z=0,M=0;if(E.style.drawmode==="point"){if(E.style.linescale===0){M=E.style.linewidth*0.5}else{M=(E.style.linewidth*E.style.linescale)/this._perspectiveScale*0.5}}for(var D=0,N,F,C,y=0;D<J;D++){N=E.points[D];F=vec4.set(E._worldcoords[D],N.x,N.y,N.z,1);if(B){vec4.transformMat4(E._worldcoords[D],F,B)}vec4.transformMat4(E._cameracoords[D],E._worldcoords[D],q);vec4.transformMat4(E._coords[D],E._cameracoords[D],n);F=E._coords[D];C=F[3];if(C===0){C=Phoria.EPSILON}z+=(E._clip[D]=(F[0]>C+M||F[0]<-C-M||F[1]>C+M||F[1]<-C-M||F[2]>C||F[2]<-C)?1:0);F[0]/=C;F[1]/=C;F[0]=v*F[0]+u+v;F[1]=i*F[1]+s+i;y+=F[2]}E._averagez=J>1?y/J:y;if(z!==J){switch(E.style.geometrysortmode){default:case"automatic":case"sorted":if(E.style.geometrysortmode==="sorted"||E.style.drawmode==="solid"||E.style.shademode==="lightsource"){switch(E.style.drawmode){case"solid":Phoria.Util.sortPolygons(E.polygons,E._cameracoords);break;case"wireframe":Phoria.Util.sortEdges(E.edges,E._cameracoords);break;case"point":Phoria.Util.sortPoints(E._coords,E._worldcoords);break}}break}if(E.style.drawmode==="solid"&&E.polygons.length!==0){var A=mat4.invert(mat4.create(),B?B:mat4.create());mat4.transpose(A,A);switch(E.style.shademode){case"lightsource":for(var H=0,O,L;H<E.polygons.length;H++){if(!E.polygons[H]._worldnormal){E.polygons[H]._worldnormal=vec4.create()}O=E.polygons[H].normal;L=E.polygons[H]._worldnormal;vec3.transformMat4(L,O,A);vec3.normalize(L,L)}break}}j.push(E)}}}if(E.children&&E.children.length!==0){g.call(this,E.children,B)}}};g.call(this,this.graph,null);this.renderlist=j;this.lights=w;this._entities=o;for(var l=0,p=this.triggerHandlers.length;l<p;l++){if(this.triggerHandlers[l].trigger.call(this,this._cameraPosition,e,m)){this.triggerHandlers.splice(l,1);p--}}}}})();(function(){Phoria.Renderer=function(){};Phoria.Renderer.prototype={sort:true,sortObjects:function b(i){if(this.sort){for(var j=0,h;j<i.renderlist.length;j++){h=i.renderlist[j];switch(h.style.objectsortmode){case"sorted":break;case"front":h._averagez=Number.MIN_VALUE;break;case"back":default:h._averagez=Number.MAX_VALUE;break}}i.renderlist.sort(function g(l,k){return(l._averagez<k._averagez?1:-1)})}},calcNormalBrightness:function e(n,q,m,l){var s=[0,0,0],j=m.lights;for(var r=0,k,t;r<j.length;r++){k=j[r];if(k instanceof Phoria.DistantLight){var i=vec3.dot(q,k.worlddirection);if(i<=0){continue}t=i*k.intensity*l.style.diffuse}else{if(k instanceof Phoria.PointLight){var h=vec3.subtract(vec3.create(),n,k.worldposition),g=vec3.length(h),p;vec3.normalize(h,h);var i=vec3.dot(q,vec3.negate(h,h));if(i<=0){continue}switch(k.attenuationFactor){default:case"none":p=k.attenuation;break;case"linear":p=k.attenuation*g;break;case"squared":p=k.attenuation*g*g;break}if(l.style.specular!==0){var v=vec3.add(vec3.create(),h,m._cameraPosition),u=vec3.dot(q,vec3.normalize(v,v)),o=Math.pow(u,l.style.specular)*k.intensity/p;s[0]+=o*k.color[0];s[1]+=o*k.color[1];s[2]+=o*k.color[2]}t=l.style.diffuse*i*k.intensity/p}}s[0]+=t*k.color[0];s[1]+=t*k.color[1];s[2]+=t*k.color[2]}return s},calcPositionBrightness:function a(k,i){var n=[0,0,0];for(var m=0,j,o;m<i.length;m++){j=i[m];if(j instanceof Phoria.DistantLight){o=j.intensity}else{if(j instanceof Phoria.PointLight){var h=vec3.subtract(vec3.create(),k,j.worldposition),g=vec3.length(h),l;vec3.normalize(h,h);switch(j.attenuationFactor){case"linear":l=j.attenuation*g;break;case"squared":l=j.attenuation*g*g;break;default:case"none":l=j.attenuation;break}o=j.intensity/(l*2)}}n[0]+=o*j.color[0];n[1]+=o*j.color[1];n[2]+=o*j.color[2]}return n},inflatePolygon:function c(m,v,s){s=s||0.5;var r=new Array(m.length);for(var w=0;w<m.length;w++){r[w]=[v[m[w]][0],v[m[w]][1]]}for(var w=0,u=m.length,t,B,h,A,g,q,p,z;w<u;w++){t=(w<u-1)?(w+1):0;B=r[w][0];h=r[w][1];A=r[t][0];g=r[t][1];var o=A-B,n=g-h,l=o*o+n*n,C;if(l===0){l===Phoria.EPSILON}C=s/Math.sqrt(l);o*=C;n*=C;r[w][0]-=o;r[w][1]-=n;r[t][0]+=o;r[t][1]+=n}return r},inflatePolygonFull:function d(q,u,m){m=m||0.5;var s=[],l=new Array(q.length);for(var o=0,n=q.length,h,t,g,r,w,v,p;o<n;o++){h=u[q[o]][0];t=u[q[o]][1];if(o<n-1){g=u[q[o+1]][0];r=u[q[o+1]][1]}else{g=u[q[0]][0];r=u[q[0]][1]}w=r-t;v=-(g-h);p=Math.sqrt(w*w+v*v);w/=p;v/=p;w*=m;v*=m;s.push({x:h+w,y:t+v});s.push({x:g+w,y:r+v})}for(var o=0,n=q.length,k;o<n;o++){if(o===0){k=this.intersection(s[(n-1)*2],s[(n-1)*2+1],s[0],s[1])}else{k=this.intersection(s[(o-1)*2],s[(o-1)*2+1],s[o*2],s[o*2+1])}if(Math.abs(k[0]-u[q[o]][0])>1.5||Math.abs(k[1]-u[q[o]][1])>1.5){k[0]=u[q[o]][0];k[1]=u[q[o]][1]}l[o]=k}return l},intersection:function f(j,i,n,m){var h=i.x-j.x,p=n.x-m.x,l=n.x-j.x,g=i.y-j.y,o=n.y-m.y,k=n.y-j.y,q=(p*k-o*l)/(g*p-h*o);return[j.x+q*(i.x-j.x),j.y+q*(i.y-j.y)]}}})();(function(){Phoria.CanvasRenderer=function(e){Phoria.CanvasRenderer.superclass.constructor.call(this);this.canvas=e;this.ctx=e.getContext("2d");return this};Phoria.Util.extend(Phoria.CanvasRenderer,Phoria.Renderer,{canvas:null,ctx:null,render:function c(j,l){this.sortObjects(j);var e=this.ctx;if(!l){e.clearRect(0,0,this.canvas.width,this.canvas.height)}else{l.call(this,e)}for(var k=0,h;k<j.renderlist.length;k++){h=j.renderlist[k];e.save();if(h.style.compositeOperation){e.globalCompositeOperation=h.style.compositeOperation}switch(h.style.drawmode){case"solid":if(h.style.fillmode==="fillstroke"||h.style.fillmode==="hiddenline"){e.lineWidth=1}for(var f=0;f<h.polygons.length;f++){this.renderPolygon(e,h,j,h.polygons[f])}break;case"wireframe":e.lineWidth=h.style.linewidth;e.globalAlpha=h.style.opacity;if(h.style.shademode==="plain"){e.strokeStyle="rgb("+h.style.color[0]+","+h.style.color[1]+","+h.style.color[2]+")";e.beginPath();for(var f=0;f<h.edges.length;f++){this.renderEdge(e,h,j,h.edges[f])}e.closePath();e.stroke()}else{for(var f=0;f<h.edges.length;f++){this.renderEdge(e,h,j,h.edges[f])}}break;case"point":if(h.style.shademode==="sprite"&&h.style.sprite!==undefined){if(!h.textures){throw new Error("Entity has shademode 'sprite' but no textures defined on parent emitter.")}if(h.style.sprite>h.textures.length-1){throw new Error("Entity has shademode 'sprite' index but references missing texture on parent emitter.")}}e.globalAlpha=h.style.opacity;var g=h._coords;if(h.style.shademode==="plain"){e.fillStyle="rgb("+h.style.color[0]+","+h.style.color[1]+","+h.style.color[2]+")"}for(var f=0;f<g.length;f++){this.renderPoint(e,h,j,g[f],f)}}e.restore()}},renderPoint:function a(f,l,k,m,i){if(l._clip[i]){return}var e=l.style.linewidth;if(l.style.linescale!==0){e=(l.style.linewidth*l.style.linescale*k._perspectiveScale)/l._coords[i][3]}switch(l.style.shademode){case"plain":f.beginPath();f.arc(m[0],m[1],e,0,Phoria.TWOPI,true);f.closePath();f.fill();break;case"sprite":if(l.style.sprite!==undefined){f.drawImage(l.textures[l.style.sprite],m[0]-e,m[1]-e,e+e,e+e)}break;case"callback":if(l.onRenderHandlers!==null){for(var j=0;j<l.onRenderHandlers.length;j++){l.onRenderHandlers[j].call(l,f,m[0],m[1],e)}}break;case"lightsource":var g=this.calcPositionBrightness(l._worldcoords[i],k.lights);f.fillStyle="rgb("+Math.min(Math.ceil(g[0]*l.style.color[0]),255)+","+Math.min(Math.ceil(g[1]*l.style.color[1]),255)+","+Math.min(Math.ceil(g[2]*l.style.color[2]),255)+")";f.beginPath();f.arc(m[0],m[1],e,0,Phoria.TWOPI,true);f.closePath();f.fill();break}},renderEdge:function d(m,h,i,g){if(h._clip[g.a]&h._clip[g.b]){return}var l=h._coords;if(h.style.linescale!==0){m.lineWidth=((h.style.linewidth*h.style.linescale)/((h._coords[g.a][3]+h._coords[g.b][3])*0.5))*i._perspectiveScale}if(h.style.shademode==="lightsource"){var f=h._worldcoords[g.a],e=h._worldcoords[g.b],j=vec3.fromValues((f[0]+e[0])*0.5,(f[1]+e[1])*0.5,(f[2]+e[2])*0.5);var k=this.calcPositionBrightness(j,i.lights);m.beginPath();m.strokeStyle="rgb("+Math.min(Math.ceil(k[0]*h.style.color[0]),255)+","+Math.min(Math.ceil(k[1]*h.style.color[1]),255)+","+Math.min(Math.ceil(k[2]*h.style.color[2]),255)+")";m.moveTo(l[g.a][0],l[g.a][1]);m.lineTo(l[g.b][0],l[g.b][1]);m.closePath();m.stroke()}else{m.moveTo(l[g.a][0],l[g.a][1]);m.lineTo(l[g.b][0],l[g.b][1])}},renderPolygon:function b(u,q,C,h){var z=q._coords,B=q._clip,m=h.vertices,x=h.color?h.color:q.style.color,l=null,e,s=0,f=(h.opacity?h.opacity:q.style.opacity);var w=1;for(var A=0;A<m.length;A++){w&=B[m[A]]}if(w){return}if(!q.style.doublesided&&((z[m[0]][0]*z[m[1]][1]-z[m[1]][0]*z[m[0]][1])+(z[m[1]][0]*z[m[2]][1]-z[m[2]][0]*z[m[1]][1])+(z[m[2]][0]*z[m[0]][1]-z[m[0]][0]*z[m[2]][1])<0)){return}switch(q.style.shademode){case"plain":if(q.style.texture===undefined&&h.texture===undefined){l=x[0]+","+x[1]+","+x[2]}break;case"lightsource":e=this.calcNormalBrightness(Phoria.Util.averagePolyVertex(m,q._worldcoords),h._worldnormal,C,q);if(h.emit||q.style.emit){s=h.emit?h.emit:q.style.emit}l=Math.min(Math.ceil(e[0]*x[0]+x[0]*s),255)+","+Math.min(Math.ceil(e[1]*x[1]+x[1]*s),255)+","+Math.min(Math.ceil(e[2]*x[2]+x[1]*s),255);break}u.save();if(q.style.texture!==undefined||h.texture!==undefined){var E=q.textures[h.texture!==undefined?h.texture:q.style.texture],G,o,F,n,D,k;var t=function(P,M,S,L,R,K,Q){var V=P[0][0],H=P[0][1],U=P[1][0],v=P[1][1],T=P[2][0],j=P[2][1];u.beginPath();u.moveTo(V,H);u.lineTo(U,v);u.lineTo(T,j);u.closePath();u.clip();var i=i=1/(M*(Q-R)-L*Q+K*R+(L-K)*S);var X=-(S*(T-U)-R*T+Q*U+(R-Q)*V)*i,W=(R*j+S*(v-j)-Q*v+(Q-R)*H)*i,J=(M*(T-U)-L*T+K*U+(L-K)*V)*i,I=-(L*j+M*(v-j)-K*v+(K-L)*H)*i,O=(M*(Q*U-R*T)+S*(L*T-K*U)+(K*R-L*Q)*V)*i,N=(M*(Q*v-R*j)+S*(L*j-K*v)+(K*R-L*Q)*H)*i;u.transform(X,W,J,I,O,N);u.globalAlpha=f;u.drawImage(E,0,0)};if(l!==null){var g=e[0]*0.3+e[1]*0.6+e[2]*0.1;if(g>1){g=1}u.fillStyle="rgba("+l+","+(1-g).toFixed(3)+")"}if(m.length===3){G=0,o=0,F=E.width,n=0,D=E.width,k=E.height;if(h.uvs!==undefined){G=E.width*h.uvs[0];o=E.height*h.uvs[1];F=E.width*h.uvs[2];n=E.height*h.uvs[3];D=E.width*h.uvs[4];k=E.height*h.uvs[5]}var r=this.inflatePolygon(m,z,0.5);t.call(this,r,G,o,F,n,D,k);if(l!==null){u.fill()}}else{if(m.length===4){G=0,o=0,F=E.width,n=0,D=E.width,k=E.height;if(h.uvs!==undefined){G=E.width*h.uvs[0];o=E.height*h.uvs[1];F=E.width*h.uvs[2];n=E.height*h.uvs[3];D=E.width*h.uvs[4];k=E.height*h.uvs[5]}u.save();var r=this.inflatePolygon(m.slice(0,3),z,0.5);t.call(this,r,G,o,F,n,D,k);u.restore();G=E.width,o=E.height,F=0,n=E.height,D=0,k=0;if(h.uvs!==undefined){G=E.width*h.uvs[4];o=E.height*h.uvs[5];F=E.width*h.uvs[6];n=E.height*h.uvs[7];D=E.width*h.uvs[0];k=E.height*h.uvs[1]}u.save();var p=new Array(3);p[0]=m[2];p[1]=m[3];p[2]=m[0];r=this.inflatePolygon(p,z,0.5);t.call(this,r,G,o,F,n,D,k);u.restore();if(l!==null){r=this.inflatePolygon(m,z,0.75);u.beginPath();u.moveTo(r[0][0],r[0][1]);for(var A=1,y=r.length;A<y;A++){u.lineTo(r[A][0],r[A][1])}u.closePath();u.globalAlpha=f;u.fill()}}}}else{if(q.style.fillmode==="inflate"){var r=this.inflatePolygon(m,z,0.5);u.beginPath();u.moveTo(r[0][0],r[0][1]);for(var A=1,y=m.length;A<y;A++){u.lineTo(r[A][0],r[A][1])}u.closePath()}else{u.beginPath();u.moveTo(z[m[0]][0],z[m[0]][1]);for(var A=1;A<m.length;A++){u.lineTo(z[m[A]][0],z[m[A]][1])}u.closePath()}l="rgba("+l+","+f+")";switch(q.style.fillmode){case"fill":u.fillStyle=l;u.fill();break;case"filltwice":u.fillStyle=l;u.fill();u.fill();break;case"inflate":u.fillStyle=l;u.fill();break;case"fillstroke":u.fillStyle=l;u.fill();u.strokeStyle=l;u.stroke();break;case"hiddenline":u.strokeStyle=l;u.stroke();break}}u.restore()}})})();(function(){Phoria.SoftwareRenderer=function(e){Phoria.SoftwareRenderer.superclass.constructor.call(this);this.canvas=e;this.ctx=e.getContext("2d");this._imagedata=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);this._data=this._imagedata.data;return this};Phoria.Util.extend(Phoria.SoftwareRenderer,Phoria.Renderer,{canvas:null,ctx:null,_imagedata:null,_data:null,render:function c(h){this.sortObjects(h);this.clearCanvasRect(0,0,this.canvas.width,this.canvas.height);for(var j=0,g;j<h.renderlist.length;j++){g=h.renderlist[j];switch(g.style.drawmode){case"solid":var e=0;for(var f=0;f<g.polygons.length;f++){if(this.renderPolygon(null,g,h,g.polygons[f])){e++}}break}}this.ctx.putImageData(this._imagedata,0,0,0,0,this.canvas.width,this.canvas.height)},clearCanvasRect:function b(e,m,i,f){var g=(e+m*this.canvas.width-1)*4+3,k=(this.canvas.width-(i-e))*4,h=this._data;for(var j=m;j<f;j++){for(var l=e;l<i;l++){h[g+=4]=0}g+=k}},renderPolygon:function a(p,k,l,e){var o=k._coords,f=k._clip,m=e.vertices,g=e.color?e.color:k.style.color;var h=1;for(var j=0;j<m.length;j++){h&=f[m[j]]}if(h){return false}if(!k.style.doublesided&&((o[m[0]][0]*o[m[1]][1]-o[m[1]][0]*o[m[0]][1])+(o[m[1]][0]*o[m[2]][1]-o[m[2]][0]*o[m[1]][1])+(o[m[2]][0]*o[m[0]][1]-o[m[0]][0]*o[m[2]][1])<0)){return}var n;switch(k.style.shademode){case"plain":n=new Array(3);n[0]=g[0];n[1]=g[1];n[2]=g[2];break;case"lightsource":n=this.calcNormalBrightness(Phoria.Util.averagePolyVertex(m,k._worldcoords),e._worldnormal,l,k);n[0]=Math.ceil(Math.min(n[0]*g[0],255));n[1]=Math.ceil(Math.min(n[1]*g[1],255));n[2]=Math.ceil(Math.min(n[2]*g[2],255));break}this.drawTriangle(o[m[2]][0],o[m[2]][1],o[m[1]][0],o[m[1]][1],o[m[0]][0],o[m[0]][1],n[0],n[1],n[2]);if(m.length===4){this.drawTriangle(o[m[0]][0],o[m[0]][1],o[m[3]][0],o[m[3]][1],o[m[2]][0],o[m[2]][1],n[0],n[1],n[2])}return true},drawTriangle:function d(s,V,q,T,o,S,I,O,Q){var s=Math.round(16*s),q=Math.round(16*q),o=Math.round(16*o),V=Math.round(16*V),T=Math.round(16*T),S=Math.round(16*S);var C=s-q,p=q-o,U=o-s,w=V-T,k=T-S,N=S-V;var E=C<<4,t=p<<4,e=U<<4,A=w<<4,n=k<<4,R=N<<4;var L=this.canvas.width,m=this.canvas.height,P=this._data;var l=Math.max((Math.min(s,q,o)+15)>>4,0),F=Math.min((Math.max(s,q,o)+15)>>4,L),B=Math.max((Math.min(V,T,S)+15)>>4,0),f=Math.min((Math.max(V,T,S)+15)>>4,m);if(F<=l||f<=B){return}var j=w*s-C*V,i=k*q-p*T,h=N*o-U*S;if(w<0||(w==0&&C>0)){j++}if(k<0||(k==0&&p>0)){i++}if(N<0||(N==0&&U>0)){h++}var z=j+C*(B<<4)-w*(l<<4),v=i+p*(B<<4)-k*(l<<4),u=h+U*(B<<4)-N*(l<<4),M,K,J;for(var D=B,G,H;D<f;D++){M=z;K=v;J=u;for(G=l;G<F;G++){if(M>0&&K>0&&J>0){H=(G+D*L)<<2;P[H]=I;P[H+1]=O;P[H+2]=Q;P[H+3]=255}M-=A;K-=n;J-=R}z+=E;v+=t;u+=e}}})})();(function(){Phoria.View={};Phoria.View.events={};Phoria.View.addMouseEvents=function e(j,i){if(j.id){var h={velocityH:0,velocityLastH:0,positionX:0,clickPositionX:0,velocityV:0,velocityLastV:0,positionY:0,clickPositionY:0};Phoria.View.events[j.id]=h;h.onMouseMove=function l(m){h.positionX=m.clientX;h.velocityH=h.velocityLastH+(h.positionX-h.clickPositionX)*0.5;h.positionY=m.clientY;h.velocityV=h.velocityLastV+(h.positionY-h.clickPositionY)*0.5};h.onMouseUp=function g(m){j.removeEventListener("mousemove",h.onMouseMove,false)};h.onMouseOut=function f(m){j.removeEventListener("mousemove",h.onMouseMove,false)};h.onMouseDown=function k(m){m.preventDefault();j.addEventListener("mousemove",h.onMouseMove,false);h.clickPositionX=m.clientX;h.velocityLastH=h.velocityH;h.clickPositionY=m.clientY;h.velocityLastV=h.velocityV};j.addEventListener("mousedown",h.onMouseDown,false);j.addEventListener("mouseup",h.onMouseUp,false);j.addEventListener("mouseout",h.onMouseOut,false);if(i){j.addEventListener("click",i,false)}return h}};Phoria.View.removeMouseEvents=function b(h,g){if(h.id){var f=Phoria.View.events[h.id];if(f){h.removeEventListener("mousemove",f.onMouseMove,false);h.removeEventListener("mousedown",f.onMouseDown,false);h.removeEventListener("mouseup",f.onMouseUp,false);h.removeEventListener("mouseout",f.onMouseOut,false);if(g){h.removeEventListener("click",g,false)}Phoria.View.events[h.id]=null}}};Phoria.View.getMouse=function d(f){return Phoria.View.events[f.id]};Phoria.View.calculateClickPointAndVector=function c(i,r,p){var o=vec3.fromValues(i.camera.lookat.x,i.camera.lookat.y,i.camera.lookat.z);var m=vec3.subtract(vec3.create(),i._cameraPosition,o);var h=(i.viewport.height/2)/(vec3.length(m)*Math.tan((i.perspective.fov/180*Math.PI)/2));var n=vec2.fromValues(r-(i.viewport.width/2),p-(i.viewport.height/2));vec2.subtract(n,n,new vec2.fromValues(8,8));var k=vec2.create();vec2.scale(k,n,1/h);var f=vec3.fromValues(i.camera.up.x,i.camera.up.y,i.camera.up.z);var j=vec3.create();vec3.cross(j,m,f);vec3.normalize(j,j);var l=vec3.scaleAndAdd(vec3.create(),o,j,k[0]);var g=vec3.create();vec3.cross(g,j,m);vec3.normalize(g,g);vec3.scale(g,g,k[1]);vec3.subtract(l,l,g);var q=vec3.add(vec3.create(),o,m);return{clickPoint:l,clickVector:vec3.subtract(vec3.create(),l,q)}};Phoria.View.getIntersectedObjects=function a(t,w,v){var g=[],r,l,z,s,x,p;var y=t.renderlist;for(var f=0,r;f<y.length;f++){r=y[f];if(r.style.drawmode!=="solid"){continue}for(var k=0;k<r.polygons.length;k++){l=vec3.clone(r.polygons[k]._worldnormal);z=vec3.clone(r._worldcoords[r.polygons[k].vertices[0]]);x=Phoria.Util.planeLineIntersection(l,z,v,w);if(x!==null){if(Phoria.Util.intersectionInsidePolygon(r.polygons[k],r._worldcoords,x)){var u={entity:r,polygonIndex:k,intersectionPoint:x};g.push(u)}}}}for(var q=0;q<g.length;q++){g[q].distance=vec3.distance(t._cameraPosition,g[q].intersectionPoint)}for(var q=0;q<g.length-1;q++){for(var o=q+1,h;o<g.length;o++){if(g[q].distance>=g[o].distance){h=g[o];g[o]=g[q];g[q]=h}}}return g}})();